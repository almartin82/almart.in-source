?save
source('~/.active-rstudio-document', echo=TRUE)
layout <- readr::read_csv("datasets/njask_layout.csv")
head(layout)
names(layout) <- tolower(gsub(' ', '_', names(layout)))
getwd()
layout <- readr::read_csv("content/datasets/njask_layout.csv")
head(layout)
names(layout) <- tolower(gsub(' ', '_', names(layout)))
with_spanners <- sqldf('
SELECT keepers.*
,spanners.data_type AS spanner
,spanners.field_length AS spanner_length
FROM keepers
LEFT OUTER JOIN spanners
ON keepers.field_start_position >= spanners.field_start_position
AND keepers.field_end_position <= spanners.field_end_position
')
with_spanners[1:20, c(1:5,8:10)]
spanners <- dplyr::filter(layout, structural==TRUE)
keepers <- dplyr::filter(layout, structural==FALSE)
head(spanners)
with_spanners <- sqldf('
SELECT keepers.*
,spanners.data_type AS spanner
,spanners.field_length AS spanner_length
FROM keepers
LEFT OUTER JOIN spanners
ON keepers.field_start_position >= spanners.field_start_position
AND keepers.field_end_position <= spanners.field_end_position
')
with_spanners[1:20, c(1:5,8:10)]
with_rn <- with_spanners %>%
dplyr::group_by(
field_start_position, field_end_position, field_length,
data_type, description, comments, valid_values
) %>%
mutate(
rn = order(desc(spanner_length))
) %>%
select(
field_start_position, field_end_position, field_length,
data_type, description, comments, valid_values, spanner, rn
) %>%
as.data.frame()
with_rn$rn <- paste0('spanner', with_rn$rn)
#mask NAS
with_rn$spanner <- ifelse(is.na(with_rn$spanner),'', with_rn$spanner)
head(with_rn)
layout_wide <- dcast(
data = with_rn,
formula = field_start_position + field_end_position + field_length +
data_type + description + comments + valid_values ~ rn,
value.var = "spanner"
)
#this appears to be a bug in dcast?  should not be needed.
layout_wide$spanner2 <- ifelse(is.na(layout_wide$spanner2),'', layout_wide$spanner2)
layout_wide[1:20, ]
layout_wide$final_name <- layout_wide %$% paste(spanner1, spanner2, description, sep='_')
#kill double underscores
layout_wide$final_name <- gsub('__', '_', layout_wide$final_name)
#kill leading or trailer underscores
layout_wide$final_name <- gsub("(^_+|_+$)", "", layout_wide$final_name)
#all whitespace becomes underscore
layout_wide$final_name <- gsub(' ', '_', layout_wide$final_name)
head(layout_wide)
sample_file = "http://www.state.nj.us/education/schools/achievement/14/njask8/state_summary.txt"
njask14_gr8 <- readr::read_fwf(
file = sample_file,
col_positions = readr::fwf_positions(
start = layout_wide$field_start_position,
end = layout_wide$field_end_position,
col_names = layout_wide$final_name
),
na = "*"
)
save(layout_wide, file = 'datasets/njask_layout.rda')
save(layout_wide, file = 'content/datasets/njask_layout.rda')
