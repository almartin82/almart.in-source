Title: Working with NJASK data in R: part 2 in a series.
Date: 2015-04-14
Status: draft
Category: education
Tags: NJ, NJASK, data_management, tutorial
Slug: reading-njask-data-2
Author: Andrew Martin

```{r, echo=FALSE}
#SET THIS TO TRUE WHEN READY TO PUBLISH
ready_to_ship = TRUE

library(knitr)
hook_plot <- knit_hooks$get('plot')

knit_hooks$set(plot=function(x, options) {
    if (!is.null(options$pelican.publish) && options$pelican.publish) {
        x <- paste0("{filename}", x)
    }
    hook_plot(x, options)
})
opts_chunk$set(dev='Cairo_svg')
opts_chunk$set(pelican.publish=ready_to_ship)

```

In my [last post]('/reading-njask-data-1.html'), I showed how to read a fixed width file into R.  In this post, I'll refactor that code into a function that takes year/grade as a parameter.

First, read in the layout data frame.  This contains the column headers for NJASK fixed with files.

```{r load_layout}

load(file = 'datasets/njask_layout.rda')

head(layout_wide)

```

Our final call to `read_fwf` in the last post looked like this:

```{r final_fwf}

sample_file = "http://www.state.nj.us/education/schools/achievement/14/njask8/state_summary.txt"

njask14_gr8 <- readr::read_fwf(
  file = sample_file,
  col_positions = readr::fwf_positions(
    start = layout_wide$field_start_position,
    end = layout_wide$field_end_position,
    col_names = layout_wide$final_name
  ),
  na = "*"
)

```

A script that has a bunch of copy/paste versions of that call would probably get the job done, but we're writing for our [future selves](https://xkcd.com/1421/) here, and those url paths are easy to build.  The function should:

1) build the target url

2) use hadley's `readr` to fetch the fixed with file, using the provided field definitions.

```{r as_function}

read_njask <- function(year, grade, layout=layout_wide) {
  require(readr)
  
  #build url
  target_url <- paste0(
    "http://www.state.nj.us/education/schools/achievement/", year-2000, 
    "/njask", grade, "/state_summary.txt"
  )
  
  #read_fwf
  df <- readr::read_fwf(
    file = target_url,
    col_positions = readr::fwf_positions(
      start = layout_wide$field_start_position,
      end = layout_wide$field_end_position,
      col_names = layout_wide$final_name
    ),
    na = "*"
  )
  
  #return df
  return(df)
  
}

```

Let's give it a try!

```{r test_read_njask} 

ex <- read_njask(2014, 6)

dplyr::sample_n(ex[, sample(c(1:551), 10)], 10) %>% as.data.frame()

```
